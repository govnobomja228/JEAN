<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель | Jean Smoke</title>
  <style>
    :root {
      --primary: #81d8d0;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --danger: #e74c3c;
      --success: #2ecc71;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: var(--dark);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 20px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #67c4b9;
    }
    
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
      position: relative;
    }
    
    .close {
      position: absolute;
      right: 20px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: var(--primary);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: var(--light);
      font-weight: bold;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-processing { background-color: #f39c12; color: white; }
    .status-packing { background-color: #3498db; color: white; }
    .status-shipping { background-color: #9b59b6; color: white; }
    .status-waiting { background-color: #e67e22; color: white; }
    .status-delivered { background-color: var(--success); color: white; }
    
    .product-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
    }
    
    .product-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .edit-btn { background-color: #3498db; color: white; }
    .delete-btn { background-color: var(--danger); color: white; }
    
    .loading {
      text-align: center;
      padding: 20px;
      font-size: 18px;
      color: #666;
    }
    
    .error {
      color: var(--danger);
      padding: 10px;
      background-color: #ffe6e6;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .success {
      color: var(--success);
      padding: 10px;
      background-color: #e6ffe6;
      border-radius: 4px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Админ-панель Jean Smoke</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('orders')">Заказы</div>
      <div class="tab" onclick="switchTab('products')">Товары</div>
      <div class="tab" onclick="switchTab('add-product')">Добавить товар</div>
    </div>
    
    <div id="orders-tab" class="tab-content active">
      <h2>Управление заказами</h2>
      <div id="orders-container">
        <div class="loading">Загрузка заказов...</div>
      </div>
    </div>
    
    <div id="products-tab" class="tab-content">
      <h2>Управление товарами</h2>
      <div id="products-container">
        <div class="loading">Загрузка товаров...</div>
      </div>
    </div>
    
    <div id="add-product-tab" class="tab-content">
      <h2>Добавить новый товар</h2>
      <div id="add-product-form">
        <div class="form-group">
          <label for="product-name">Название товара:</label>
          <input type="text" id="product-name" required>
        </div>
        <div class="form-group">
          <label for="product-price">Цена (руб):</label>
          <input type="number" id="product-price" required min="0" step="0.01">
        </div>
        <div class="form-group">
          <label for="product-stock">Количество на складе:</label>
          <input type="number" id="product-stock" required min="0">
        </div>
        <div class="form-group">
          <label for="product-image">URL изображения:</label>
          <input type="url" id="product-image" placeholder="https://example.com/image.jpg">
        </div>
        <button class="btn btn-primary" onclick="addProduct()">Добавить товар</button>
        <div id="add-product-message"></div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для изменения статуса -->
  <div id="status-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('status-modal')">&times;</span>
      <h3>Изменение статуса заказа</h3>
      <div class="form-group">
        <label>Выберите новый статус:</label>
        <select id="status-select">
          <option value="В обработке">В обработке</option>
          <option value="В сборке">В сборке</option>
          <option value="В пути">В пути</option>
          <option value="Ожидает получения">Ожидает получения</option>
          <option value="Доставлен">Доставлен</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="updateOrderStatus()">Сохранить</button>
    </div>
  </div>

  <!-- Модальное окно для редактирования товара -->
  <div id="edit-product-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('edit-product-modal')">&times;</span>
      <h3>Редактирование товара</h3>
      <div class="form-group">
        <label for="edit-product-name">Название:</label>
        <input type="text" id="edit-product-name" required>
      </div>
      <div class="form-group">
        <label for="edit-product-price">Цена:</label>
        <input type="number" id="edit-product-price" required min="0" step="0.01">
      </div>
      <div class="form-group">
        <label for="edit-product-stock">Количество:</label>
        <input type="number" id="edit-product-stock" required min="0">
      </div>
      <div class="form-group">
        <label for="edit-product-image">URL изображения:</label>
        <input type="url" id="edit-product-image">
      </div>
      <input type="hidden" id="edit-product-id">
      <button class="btn btn-primary" onclick="saveProductChanges()">Сохранить</button>
    </div>
  </div>

  <script>
    let currentOrders = [];
    let currentProducts = [];
    let currentOrderId = null;
    
    // Функция для переключения вкладок
    function switchTab(tabName) {
      // Скрыть все вкладки
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Показать выбранную вкладку
      document.getElementById(tabName + '-tab').classList.add('active');
      document.querySelector(`.tab:nth-child(${['orders', 'products', 'add-product'].indexOf(tabName) + 1})`).classList.add('active');
    }
    
    // Функция для закрытия модального окна
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Функция для отображения сообщения
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => {
        element.innerHTML = '';
      }, 3000);
    }
    
    // Функция для загрузки заказов
    async function loadOrders() {
      try {
        const response = await fetch('/api/admin/orders', {
          headers: {
            'Authorization': 'Basic ' + btoa('admin:DanyaJEANsmoke')
          }
        });
        
        if (!response.ok) {
          throw new Error('Ошибка загрузки заказов');
        }
        
        currentOrders = await response.json();
        displayOrders(currentOrders);
      } catch (error) {
        document.getElementById('orders-container').innerHTML = `
          <div class="error">Ошибка загрузки заказов: ${error.message}</div>
        `;
      }
    }
    
    // Функция для отображения заказов
    function displayOrders(orders) {
      const container = document.getElementById('orders-container');
      
      if (orders.length === 0) {
        container.innerHTML = '<div class="loading">Заказов нет</div>';
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Клиент</th>
              <th>Email</th>
              <th>Адрес</th>
              <th>Товары</th>
              <th>Сумма</th>
              <th>Статус</th>
              <th>Дата</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(order => `
              <tr>
                <td>${order.id}</td>
                <td>${order.username || 'Не указан'}</td>
                <td>${order.email}</td>
                <td>${order.address}</td>
                <td>
                  ${order.items.map(item => `
                    ${item.name} × ${item.quantity}
                  `).join('<br>')}
                </td>
                <td>${order.total} ₽</td>
                <td>
                  <span class="status-badge status-${getStatusClass(order.status)}">
                    ${order.status}
                  </span>
                </td>
                <td>${new Date(order.date).toLocaleString('ru-RU')}</td>
                <td>
                  <button class="action-btn edit-btn" onclick="openStatusModal('${order.id}')">
                    Изменить статус
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    // Функция для получения класса статуса
    function getStatusClass(status) {
      const statusMap = {
        'В обработке': 'processing',
        'В сборке': 'packing',
        'В пути': 'shipping',
        'Ожидает получения': 'waiting',
        'Доставлен': 'delivered'
      };
      return statusMap[status] || 'processing';
    }
    
    // Функция для открытия модального окна изменения статуса
    function openStatusModal(orderId) {
      currentOrderId = orderId;
      document.getElementById('status-modal').style.display = 'block';
    }
    
    // Функция для обновления статуса заказа
    async function updateOrderStatus() {
      try {
        const newStatus = document.getElementById('status-select').value;
        
        const response = await fetch(`/api/admin/orders/${currentOrderId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa('admin:DanyaJEANsmoke')
          },
          body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
          throw new Error('Ошибка обновления статуса');
        }
        
        closeModal('status-modal');
        loadOrders(); // Перезагружаем заказы
        showMessage('orders-container', 'Статус успешно обновлен', 'success');
      } catch (error) {
        showMessage('orders-container', `Ошибка: ${error.message}`, 'error');
      }
    }
    
    // Функция для загрузки товаров
    async function loadProducts() {
      try {
        const response = await fetch('/api/admin/products', {
          headers: {
            'Authorization': 'Basic ' + btoa('admin:DanyaJEANsmoke')
          }
        });
        
        if (!response.ok) {
          throw new Error('Ошибка загрузки товаров');
        }
        
        currentProducts = await response.json();
        displayProducts(currentProducts);
      } catch (error) {
        document.getElementById('products-container').innerHTML = `
          <div class="error">Ошибка загрузки товаров: ${error.message}</div>
        `;
      }
    }
    
    // Функция для отображения товаров
    function displayProducts(products) {
      const container = document.getElementById('products-container');
      
      if (products.length === 0) {
        container.innerHTML = '<div class="loading">Товаров нет</div>';
        return;
      }
      
      container.innerHTML = products.map(product => `
        <div class="product-card">
          <h3>${product.name}</h3>
          <img src="${product.image}" alt="${product.name}" class="product-image">
          <p><strong>Цена:</strong> ${product.price} ₽</p>
          <p><strong>На складе:</strong> ${product.stock} шт.</p>
          <p><strong>ID:</strong> ${product.id}</p>
          <div class="actions">
            <button class="action-btn edit-btn" onclick="openEditProductModal('${product.id}')">
              Редактировать
            </button>
            <button class="action-btn delete-btn" onclick="deleteProduct('${product.id}')">
              Удалить
            </button>
          </div>
        </div>
      `).join('');
    }
    
    // Функция для открытия модального окна редактирования товара
    function openEditProductModal(productId) {
      const product = currentProducts.find(p => p.id === productId);
      if (product) {
        document.getElementById('edit-product-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-price').value = product.price;
        document.getElementById('edit-product-stock').value = product.stock;
        document.getElementById('edit-product-image').value = product.image;
        document.getElementById('edit-product-modal').style.display = 'block';
      }
    }
    
    // Функция для сохранения изменений товара
    async function saveProductChanges() {
      try {
        const productId = document.getElementById('edit-product-id').value;
        const name = document.getElementById('edit-product-name').value;
        const price = parseFloat(document.getElementById('edit-product-price').value);
        const stock = parseInt(document.getElementById('edit-product-stock').value);
        const image = document.getElementById('edit-product-image').value;
        
        const response = await fetch(`/api/admin/products/${productId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa('admin:DanyaJEANsmoke')
          },
          body: JSON.stringify({ name, price, stock, image })
        });
        
        if (!response.ok) {
          throw new Error('Ошибка обновления товара');
        }
        
        closeModal('edit-product-modal');
        loadProducts(); // Перезагружаем товары
        showMessage('products-container', 'Товар успешно обновлен', 'success');
      } catch (error) {
        showMessage('products-container', `Ошибка: ${error.message}`, 'error');
      }
    }
    
    // Функция для удаления товара
    async function deleteProduct(productId) {
      if (!confirm('Вы уверены, что хотите удалить этот товар?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/products/${productId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Basic ' + btoa('admin:DanyaJEANsmoke')
          }
        });
        
        if (!response.ok) {
          throw new Error('Ошибка удаления товара');
        }
        
        loadProducts(); // Перезагружаем товары
        showMessage('products-container', 'Товар успешно удален', 'success');
      } catch (error) {
        showMessage('products-container', `Ошибка: ${error.message}`, 'error');
      }
    }
    
    // Функция для добавления нового товара
    async function addProduct() {
      try {
        const name = document.getElementById('product-name').value;
        const price = parseFloat(document.getElementById('product-price').value);
        const stock = parseInt(document.getElementById('product-stock').value);
        const image = document.getElementById('product-image').value;
        
        if (!name || isNaN(price) || isNaN(stock)) {
          showMessage('add-product-message', 'Заполните все обязательные поля', 'error');
          return;
        }
        
        const response = await fetch('/api/admin/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa('admin:DanyaJEANsmoke')
          },
          body: JSON.stringify({ name, price, stock, image })
        });
        
        if (!response.ok) {
          throw new Error('Ошибка добавления товара');
        }
        
        // Очищаем форму
        document.getElementById('product-name').value = '';
        document.getElementById('product-price').value = '';
        document.getElementById('product-stock').value = '';
        document.getElementById('product-image').value = '';
        
        showMessage('add-product-message', 'Товар успешно добавлен', 'success');
        loadProducts(); // Перезагружаем список товаров
      } catch (error) {
        showMessage('add-product-message', `Ошибка: ${error.message}`, 'error');
      }
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
      loadOrders();
      loadProducts();
    });
  </script>
</body>
</html>