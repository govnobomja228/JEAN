<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Jean Smoke - Магазин</title>
<style>
body {
  font-family: 'Arial', sans-serif;
  background-image: url("https://i.pinimg.com/736x/6b/3e/84/6b3e84a1a62b6b6386a9cdffd3bbd63c.jpg");
  margin: 0;
  padding: 20px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  touch-action: manipulation;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

.error-message {
  color: #ff5555;
  text-align: center;
  padding: 20px;
  background: rgba(255, 85, 85, 0.1);
  border-radius: 8px;
  margin: 20px;
}

.header {
  display: flex;
  justify-content: flex-end;
  width: 100%;
  max-width: 1200px;
  margin-bottom: 20px;
  align-items: center;
  flex-wrap: wrap;
}

.glow-on-hover {
  width: 120px;
  height: 40px;
  border: none;
  outline: none;
  color: #fff;
  background: #111;
  cursor: pointer;
  position: relative;
  z-index: 0;
  border-radius: 10px;
  margin-left: 10px;
  margin-top: 10px;
  font-weight: bold;
}

.glow-on-hover:before {
  content: '';
  background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
  position: absolute;
  top: -2px;
  left:-2px;
  background-size: 400%;
  z-index: -1;
  filter: blur(5px);
  width: calc(100% + 4px);
  height: calc(100% + 4px);
  animation: glowing 20s linear infinite;
  opacity: 0;
  transition: opacity .3s ease-in-out;
  border-radius: 10px;
}

.glow-on-hover:hover:before {
  opacity: 1;
}

.user-id {
  color: white;
  margin-right: 15px;
  font-size: 1em;
  background: rgba(255,255,255,0.1);
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: bold;
  flex-grow: 1;
  word-break: break-all;
  font-size: 0.9em;
}

@keyframes glowing {
  0% { background-position: 0 0; }
  50% { background-position: 400% 0; }
  100% { background-position: 0 0; }
}

.product-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
  width: 100%;
  max-width: 1200px;
}

.product-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
}

.product-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}

.product-name {
  font-weight: bold;
  margin: 5px 0;
  color: white;
  font-size: 1.1em;
}

.product-price {
  color: #81d8d0;
  font-size: 1.3em;
  margin: 5px 0;
  font-weight: bold;
}

.counter-container {
  display: flex;
  align-items: center;
  margin-top: 10px;
  justify-content: center;
}

.qty-btn {
  width: 35px;
  height: 35px;
  border: none;
  background: #81d8d0;
  color: white;
  font-size: 1.5em;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.quantity {
  margin: 0 15px;
  color: white;
  font-size: 1.2em;
  min-width: 30px;
  text-align: center;
}

.stock-info {
  color: #ccc;
  font-size: 0.9em;
  margin-top: 5px;
  text-align: center;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
  overflow: auto;
}

.modal-content {
  background: rgba(0,0,0,0.9);
  margin: 5% auto;
  padding: 25px;
  border: 2px solid #81d8d0;
  width: 90%;
  max-width: 700px;
  border-radius: 15px;
  color: white;
  position: relative;
}

.close {
  color: #aaa;
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover {
  color: white;
}

.order-item {
  border-bottom: 1px solid #333;
  padding: 15px 0;
  margin-bottom: 10px;
}

.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.order-id {
  font-size: 1.2em;
  font-weight: bold;
  color: #81d8d0;
}

.order-status {
  padding: 5px 12px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 0.9em;
}

.status-processing {
  background: rgba(255, 165, 0, 0.2);
  color: #FFA500;
}

.status-delivery {
  background: rgba(30, 144, 255, 0.2);
  color: #1E90FF;
}

.status-waiting {
  background: rgba(153, 50, 204, 0.2);
  color: #9932CC;
}

.status-completed {
  background: rgba(50, 205, 50, 0.2);
  color: #32CD32;
}

.order-details {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 15px;
}

.order-items {
  background: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 8px;
}

.order-item-row {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
}

.order-summary {
  background: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 8px;
  text-align: right;
}

.order-total {
  font-size: 1.3em;
  font-weight: bold;
  color: #81d8d0;
  margin-top: 10px;
}

.empty-orders {
  text-align: center;
  padding: 30px;
  font-size: 1.2em;
  color: #81d8d0;
}

.loading {
  text-align: center;
  padding: 30px;
  font-size: 1.2em;
  color: #81d8d0;
}

.loading:after {
  content: ' .';
  animation: dots 1.5s infinite;
}

@keyframes dots {
  0%, 20% { content: ' .'; }
  40%, 60% { content: ' ..'; }
  80%, 100% { content: ' ...'; }
}

/* Стили для админ-панели */
.admin-panel {
  display: none;
  background: rgba(0,0,0,0.8);
  padding: 20px;
  border-radius: 10px;
  margin: 30px auto;
  width: 100%;
  max-width: 1200px;
  border: 2px solid #81d8d0;
}

.admin-panel h2 {
  color: #81d8d0;
  text-align: center;
  margin-top: 0;
}

.admin-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.admin-table th, .admin-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid rgba(129, 216, 208, 0.3);
}

.admin-table th {
  background-color: rgba(129, 216, 208, 0.1);
  color: #81d8d0;
}

.admin-input {
  width: 100%;
  padding: 8px;
  background: rgba(255,255,255,0.1);
  border: 1px solid #81d8d0;
  border-radius: 4px;
  color: white;
}

.admin-btn {
  padding: 8px 16px;
  background: #81d8d0;
  color: #111;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.admin-btn:hover {
  background: #67c4b9;
  transform: translateY(-2px);
}

.admin-btn.delete {
  background: #ff5555;
  color: white;
}

.admin-btn.delete:hover {
  background: #ff3333;
}

.secret-admin-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 50px;
  height: 50px;
  background: rgba(129, 216, 208, 0.7);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1.2em;
  font-weight: bold;
  cursor: pointer;
  z-index: 1000;
  display: none;
  box-shadow: 0 0 10px rgba(129, 216, 208, 0.5);
  transition: all 0.3s;
}

.secret-admin-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 15px rgba(129, 216, 208, 0.8);
}

.admin-code-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
}

.admin-code-content {
  background: rgba(0,0,0,0.9);
  margin: 15% auto;
  padding: 25px;
  border: 2px solid #81d8d0;
  width: 90%;
  max-width: 400px;
  border-radius: 15px;
  color: white;
  position: relative;
  text-align: center;
}

.admin-code-content h2 {
  color: #81d8d0;
  margin-top: 0;
}

.admin-code-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
}

.admin-code-form input {
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border: 1px solid #81d8d0;
  border-radius: 8px;
  color: white;
  font-size: 1.1em;
  text-align: center;
}

.admin-code-form button {
  padding: 12px;
  background: #81d8d0;
  color: #111;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1.1em;
}

.admin-error {
  color: #ff5555;
  margin-top: 10px;
  display: none;
}

/* Адаптация для мобильных */
@media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .user-id {
    margin: 10px 0;
    text-align: center;
    width: auto;
  }
  
  .glow-on-hover {
    width: 100%;
    margin: 5px 0;
  }
  
  .product-list {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .counter-container {
    justify-content: center;
  }
  
  .modal-content {
    width: 95%;
    margin: 10% auto;
    padding: 15px;
  }
  
  .secret-admin-btn {
    bottom: 10px;
    left: 10px;
    width: 40px;
    height: 40px;
    font-size: 1em;
  }
  
  .admin-panel {
    padding: 10px;
    margin: 15px 0;
  }
  
  .admin-table {
    font-size: 0.8em;
  }
  
  .admin-table th, .admin-table td {
    padding: 6px;
  }
  
  .order-details {
    grid-template-columns: 1fr;
  }
}

.status-history {
  margin-top: 15px;
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
}

.status-entry {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
  border-bottom: 1px solid #333;
}

.status-entry:last-child {
  border-bottom: none;
}

.status-date {
  color: #aaa;
}

/* Цвета статусов */
.status-в-обработке {
  background: rgba(255, 165, 0, 0.2);
  color: #FFA500;
}

.status-в-сборке {
  background: rgba(0, 191, 255, 0.2);
  color: #00BFFF;
}

.status-в-пути {
  background: rgba(138, 43, 226, 0.2);
  color: #8A2BE2;
}

.status-ожидает-получения {
  background: rgba(255, 215, 0, 0.2);
  color: #FFD700;
}

.status-доставлен {
  background: rgba(50, 205, 50, 0.2);
  color: #32CD32;
}

.order-status {
  padding: 5px 10px;
  border-radius: 15px;
  font-weight: bold;
  font-size: 0.9em;
}

.status-processing {
  background-color: #FFF3CD;
  color: #856404;
}

.status-assembling {
  background-color: #D1ECF1;
  color: #0C5460;
}

.status-delivery {
  background-color: #D4EDDA;
  color: #155724;
}

.status-waiting {
  background-color: #E2E3E5;
  color: #383D41;
}

.status-delivered {
  background-color: #CCE5FF;
  color: #004085;
}

.order-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  border: 1px solid rgba(129, 216, 208, 0.3);
  transition: all 0.3s ease;
}

.order-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.order-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.order-id {
  font-weight: bold;
  color: #81d8d0;
}

.order-date {
  color: #aaa;
  font-size: 0.9em;
}

.order-status {
  display: inline-block;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 0.8em;
  margin: 5px 0;
}

.order-status.в-обработке {
  background: rgba(255, 165, 0, 0.2);
  color: #ffa500;
}

.order-status.доставлен {
  background: rgba(50, 205, 50, 0.2);
  color: #32cd32;
}

.order-total {
  font-size: 1.2em;
  font-weight: bold;
  margin: 10px 0;
}

.order-details-btn {
  background: rgba(129, 216, 208, 0.2);
  border: 1px solid #81d8d0;
  color: #81d8d0;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s;
}

.order-details-btn:hover {
  background: rgba(129, 216, 208, 0.4);
}

.empty-orders {
  text-align: center;
  padding: 30px;
  color: #81d8d0;
}

.empty-orders i {
  font-size: 2em;
  margin-bottom: 15px;
}

</style>
</head>
<body>

<div class="header">
  <div class="user-id">Ваш ID: <span id="userId">загрузка...</span></div>
  <button class="glow-on-hover" id="myOrdersBtn">Мои заказы</button>
  <button class="glow-on-hover" id="cartBtn">Корзина</button>
  <button class="glow-on-hover" id="contactBtn">Связаться</button>
</div>

<div class="product-list" id="productList">
  <div class="loading">Загрузка товаров</div>
</div>

<!-- Секретная кнопка админа -->
<button class="secret-admin-btn" id="secretAdminBtn">A</button>

<!-- Админ панель -->
<div class="admin-panel" id="adminPanel">
  <h2>Панель администратора</h2>
  <div class="admin-controls">
    <button class="admin-btn" id="refreshProductsBtn">Обновить список</button>
    <button class="admin-btn" id="addProductBtn">Добавить товар</button>
  </div>
  <table class="admin-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Название</th>
        <th>Цена</th>
        <th>Остаток</th>
        <th>Изображение</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody id="adminProductsList"></tbody>
  </table>
</div>

<!-- Модальное окно заказов -->
<div id="ordersModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2 style="text-align: center; color: #81d8d0; margin-bottom: 20px;">История заказов</h2>
    <div id="ordersList" class="loading">Загрузка заказов...</div>
  </div>
</div>

<!-- Модальное окно для кода админа -->
<div id="adminCodeModal" class="admin-code-modal">
  <div class="admin-code-content">
    <span class="close">&times;</span>
    <h2>Доступ администратора</h2>
    <p>Введите секретный код</p>
    <div class="admin-code-form">
      <input type="password" id="adminCodeInput" placeholder="Код доступа" required>
      <div class="admin-error" id="adminCodeError"></div>
      <button id="submitAdminCodeBtn">Подтвердить</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://poised-valuable-chef.glitch.me';
const ADMIN_CODE = 'DanyaJEANsmoke'; // Ваш секретный код

// Инициализация данных
if (!localStorage.getItem('cartQuantities')) {
  localStorage.setItem('cartQuantities', JSON.stringify({}));
}

let products = [];
let cartQuantities = JSON.parse(localStorage.getItem('cartQuantities')) || {};
let userId = localStorage.getItem('userId');

// Инициализация пользователя
function initUser() {
  userId = localStorage.getItem('userId');
  
  if (!userId) {
    try {
      fetch(`${API_URL}/api/register`)
        .then(res => res.json())
        .then(data => {
          if (data && data.userId) {
            userId = data.userId;
            localStorage.setItem('userId', userId);
            document.getElementById('userId').textContent = userId;
          } else {
            throw new Error('Неверный ответ сервера');
          }
        })
        .catch(error => {
          console.error('Ошибка регистрации:', error);
          // Генерация временного ID
          userId = 'temp_' + Math.random().toString(36).substr(2, 8);
          localStorage.setItem('userId', userId);
          document.getElementById('userId').textContent = userId;
        });
    } catch (e) {
      console.error('Критическая ошибка:', e);
      // Резервный ID
      userId = 'backup_' + Date.now().toString(36);
      localStorage.setItem('userId', userId);
      document.getElementById('userId').textContent = userId;
    }
  } else {
    document.getElementById('userId').textContent = userId;
  }
  return userId;
}

  try {
    // Добавляем параметры запроса
    const url = new URL(`${API_URL}/api/user/orders`);
    url.searchParams.append('userId', userId);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include' // Важно для CORS
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    
    if (result.data.length === 0) {
      ordersContainer.innerHTML = `
        <div class="empty-orders">
          <i class="fas fa-box-open"></i>
          <p>У вас пока нет заказов</p>
        </div>
      `;
      return;
    }

    // Рендерим заказы
    ordersContainer.innerHTML = result.data.map(order => `
      <div class="order-card">
        <div class="order-header">
          <span class="order-id">Заказ #${order.id}</span>
          <span class="order-date">${new Date(order.date).toLocaleString()}</span>
        </div>
        <div class="order-status ${order.status.toLowerCase().replace(/\s/g, '-')}">
          ${order.status}
        </div>
        <div class="order-total">${order.total} ₽</div>
        <button class="order-details-btn" data-order-id="${order.id}">
          Подробнее
        </button>
      </div>
    `).join('');

  } catch (error) {
    console.error('Order load error:', error);
    ordersContainer.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Не удалось загрузить заказы</p>
        <button onclick="loadUserOrders()">Повторить попытку</button>
      </div>
    `;
  }
}

// Проверка прав администратора
function checkAdminAccess() {
  const hasAccess = localStorage.getItem('adminAccess') === 'true';
  document.getElementById('secretAdminBtn').style.display = hasAccess ? 'block' : 'none';
  return hasAccess;
}

// Загрузка товаров
async function loadProducts() {
  try {
    const response = await fetch(`${API_URL}/api/products`);
    if (!response.ok) throw new Error('Сервер не отвечает');
    
    products = await response.json();
    renderProducts();
    
    // Если админ, обновляем панель
    if (checkAdminAccess()) {
      updateAdminProductsList(products);
    }
  } catch (error) {
    console.error('Ошибка загрузки товаров:', error);
    // Fallback данные
    products = [
      { id: 'p1', name: 'СНЮС', price: 500, image: 'https://i.pinimg.com/736x/bf/ef/40/bfef4084b193214a0a130ed2e00b87d3.jpg', stock: 150 },
      { id: 'p2', name: 'PODONKI', price: 500, image: 'https://i.pinimg.com/736x/bf/ef/40/bfef4084b193214a0a130ed2e00b87d3.jpg', stock: 120 },
      { id: 'p3', name: 'PASITO2', price: 3000, image: 'https://i.pinimg.com/736x/bf/ef/40/bfef4084b193214a0a130ed2e00b87d3.jpg', stock: 200 },
      { id: 'p4', name: 'WAKA', price: 1500, image: 'https://i.pinimg.com/736x/bf/ef/40/bfef4084b193214a0a130ed2e00b87d3.jpg', stock: 10 }
    ];
    renderProducts();
  }
}

// Отображение товаров
function renderProducts() {
  const productList = document.getElementById('productList');
  
  if (products.length === 0) {
    productList.innerHTML = '<div class="empty-orders">Товары отсутствуют</div>';
    return;
  }
  
  productList.innerHTML = '';
  
  products.forEach(product => {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    const availableStock = product.stock - (cartQuantities[product.id] || 0);

    card.innerHTML = `
      <img src="${product.image}" alt="${product.name}" class="product-image">
      <div class="product-name">${product.name}</div>
      <div class="product-price">${product.price} ₽</div>
      <div class="stock-info">Осталось: ${availableStock}</div>
      <div class="counter-container">
        <button class="qty-btn minus" data-id="${product.id}">−</button>
        <div class="quantity" data-id="${product.id}">${cartQuantities[product.id] || 0}</div>
        <button class="qty-btn plus" data-id="${product.id}">+</button>
      </div>
    `;
    
    // Обработчики кнопок +/-
    card.querySelector('.plus').addEventListener('click', () => {
      const productId = product.id;
      const available = product.stock - (cartQuantities[productId] || 0);
      
      if (available > 0) {
        cartQuantities[productId] = (cartQuantities[productId] || 0) + 1;
        card.querySelector('.quantity').textContent = cartQuantities[productId];
        card.querySelector('.stock-info').textContent = `Осталось: ${product.stock - cartQuantities[productId]}`;
        localStorage.setItem('cartQuantities', JSON.stringify(cartQuantities));
      } else {
        alert('Товар закончился!');
      }
    });

    card.querySelector('.minus').addEventListener('click', () => {
      const productId = product.id;
      if (cartQuantities[productId] > 0) {
        cartQuantities[productId]--;
        card.querySelector('.quantity').textContent = cartQuantities[productId] || '0';
        card.querySelector('.stock-info').textContent = `Осталось: ${product.stock - (cartQuantities[productId] || 0)}`;
        localStorage.setItem('cartQuantities', JSON.stringify(cartQuantities));
      }
    });
    
    productList.appendChild(card);
  });
}

// Обновление списка товаров в админ-панели
function updateAdminProductsList(products) {
  const tbody = document.getElementById('adminProductsList');
  tbody.innerHTML = '';
  
  products.forEach(product => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${product.id}</td>
      <td><input class="admin-input" value="${product.name}" data-field="name"></td>
      <td><input class="admin-input" type="number" value="${product.price}" data-field="price"></td>
      <td><input class="admin-input" type="number" value="${product.stock}" data-field="stock"></td>
      <td><input class="admin-input" value="${product.image}" data-field="image"></td>
      <td>
        <button class="admin-btn save-product-btn" data-id="${product.id}">Сохранить</button>
        <button class="admin-btn delete delete-product-btn" data-id="${product.id}">Удалить</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Обработчики сохранения
  document.querySelectorAll('.save-product-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const productId = btn.dataset.id;
      const row = btn.closest('tr');
      const inputs = row.querySelectorAll('.admin-input');
      
      const updatedProduct = { id: productId };
      inputs.forEach(input => {
        updatedProduct[input.dataset.field] = input.dataset.field === 'name' || input.dataset.field === 'image' 
          ? input.value 
          : Number(input.value);
      });
      
      try {
        const response = await fetch(`${API_URL}/api/admin/products/${productId}`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': ADMIN_CODE
          },
          body: JSON.stringify(updatedProduct)
        });
        
        if (!response.ok) throw new Error('Ошибка сохранения');
        
        alert('Товар успешно обновлен!');
        loadProducts();
      } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при обновлении товара: ' + error.message);
      }
    });
  });
  
  // Обработчики удаления
  document.querySelectorAll('.delete-product-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Вы уверены, что хотите удалить этот товар?')) return;
      
      const productId = btn.dataset.id;
      try {
        const response = await fetch(`${API_URL}/api/admin/products/${productId}`, {
          method: 'DELETE',
          headers: { 
            'Authorization': ADMIN_CODE
          }
        });
        
        if (!response.ok) throw new Error('Ошибка удаления');
        
        alert('Товар успешно удален!');
        loadProducts();
      } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при удалении товара: ' + error.message);
      }
    });
  });
}

// Загрузка и отображение заказов
function loadOrders() {
  const ordersList = document.getElementById('ordersList');
  ordersList.innerHTML = '<div class="loading">Загрузка заказов...</div>';
  
  fetch(`${API_URL}/api/orders?email=${userId}`)
    .then(res => res.json())
    .then(orders => {
      if (orders.length === 0) {
        ordersList.innerHTML = '<div class="empty-orders">У вас пока нет заказов</div>';
        return;
      }
      
      ordersList.innerHTML = orders.map(order => {
        // Определяем класс статуса для стилизации
        const statusClass = 
          order.status === 'В обработке' ? 'status-processing' :
          order.status === 'В сборке' ? 'status-assembling' :
          order.status === 'В пути' ? 'status-delivery' :
          order.status === 'Ожидает получения' ? 'status-waiting' :
          'status-delivered';
        
        return `
          <div class="order-item">
            <div class="order-header">
              <div class="order-id">Заказ #${order.id}</div>
              <div class="order-status ${statusClass}">${order.status}</div>
            </div>
            <div>Сумма: ${order.total} ₽</div>
            <div>Адрес: ${order.address}</div>
            <div>Дата: ${new Date(order.date).toLocaleString()}</div>
          </div>
        `;
      }).join('');
    })
    .catch(error => {
      console.error('Ошибка загрузки заказов:', error);
      ordersList.innerHTML = '<div class="empty-orders">Ошибка загрузки заказов</div>';
    });
}

// Переход в корзину
document.getElementById('cartBtn').addEventListener('click', () => {
  localStorage.setItem('productsData', JSON.stringify(products));
  window.location.href = 'cart.html';
});

// Кнопка связи
document.getElementById('contactBtn').addEventListener('click', () => {
  window.open('https://t.me/jeansmokeadmin', '_blank');
});

// Кнопка "Мои заказы"
document.getElementById('myOrdersBtn').addEventListener('click', () => {
  document.getElementById('ordersModal').style.display = 'block';
  loadOrders();
});

// Закрытие модальных окон
document.querySelectorAll('.close').forEach(btn => {
  btn.addEventListener('click', function() {
    this.closest('.modal').style.display = 'none';
  });
});

// Закрытие при клике вне окна
window.addEventListener('click', (event) => {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
});

// Админ-функционал
document.getElementById('secretAdminBtn').addEventListener('click', () => {
  const adminPanel = document.getElementById('adminPanel');
  adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
});

document.getElementById('refreshProductsBtn').addEventListener('click', async () => {
  try {
    await loadProducts();
    alert('Список товаров обновлен!');
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка при обновлении списка товаров');
  }
});

document.getElementById('addProductBtn').addEventListener('click', async () => {
  const newProduct = {
    name: 'Новый товар',
    price: 1000,
    stock: 10,
    image: 'https://i.pinimg.com/736x/bf/ef/40/bfef4084b193214a0a130ed2e00b87d3.jpg'
  };
  
  try {
    // Создаем базовую авторизацию
    const authString = btoa('admin:DanyaJEANsmoke');
    
    const response = await fetch(`${API_URL}/api/admin/products`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Basic ${authString}`
      },
      body: JSON.stringify(newProduct)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Ошибка добавления');
    }
    
    const data = await response.json();
    alert('Товар успешно добавлен с ID: ' + data.product.id);
    loadProducts();
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка при добавлении товара: ' + error.message);
  }
});

// Активация админ-панели
let keySequence = [];
document.addEventListener('keydown', (e) => {
  keySequence.push(e.key);
  if (keySequence.length > 5) keySequence.shift();
  
  if (keySequence.join('') === 'admin') {
    document.getElementById('adminCodeModal').style.display = 'block';
    keySequence = [];
  }
});

// Проверка кода админа
document.getElementById('submitAdminCodeBtn').addEventListener('click', () => {
  const code = document.getElementById('adminCodeInput').value;
  const errorElement = document.getElementById('adminCodeError');
  
  if (code === ADMIN_CODE) {
    localStorage.setItem('adminAccess', 'true');
    document.getElementById('adminCodeModal').style.display = 'none';
    document.getElementById('secretAdminBtn').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'block';
    alert('Доступ администратора активирован!');
  } else {
    errorElement.textContent = 'Неверный код доступа';
    errorElement.style.display = 'block';
  }
});

function loadOrders() {
  const ordersList = document.getElementById('ordersList');
  ordersList.innerHTML = '<div class="loading">Загрузка заказов</div>';
  
  fetch(`${API_URL}/api/orders?email=${userId}`)
    .then(res => res.json())
    .then(orders => {
      if (orders.length === 0) {
        ordersList.innerHTML = '<div class="empty-orders">У вас пока нет заказов</div>';
        return;
      }
      
      ordersList.innerHTML = orders.map(order => {
        const deliveryTime = new Date(order.estimatedDelivery).toLocaleString();
        const statusClass = `status-${order.status.toLowerCase().replace(/\s/g, '-')}`;
        
        return `
          <div class="order-item">
            <div class="order-header">
              <div class="order-id">Заказ #${order.id}</div>
              <div class="order-status ${statusClass}">${order.status}</div>
            </div>
            
            <div class="order-details">
              <div class="order-info">
                <div><strong>Дата заказа:</strong> ${new Date(order.date).toLocaleString()}</div>
                <div><strong>Доставка к:</strong> ${deliveryTime}</div>
                <div><strong>Адрес:</strong> ${order.address}</div>
                <div><strong>username:</strong> ${order.username}</div>
                ${order.comment ? `<div><strong>Комментарий:</strong> ${order.comment}</div>` : ''}
              </div>
              
              <div class="order-items">
                <h3>Товары:</h3>
                ${order.items.map(item => `
                  <div class="order-item-row">
                    <span>${item.name}</span>
                    <span>${item.quantity} × ${item.price} ₽ = ${item.quantity * item.price} ₽</span>
                  </div>
                `).join('')}
              </div>
              
              <div class="order-summary">
                <div class="order-total">Итого: ${order.total} ₽</div>
              </div>
            </div>
            
            <div class="status-history">
              <h3>История статусов:</h3>
              ${order.statusHistory.map(entry => `
                <div class="status-entry">
                  <span class="status-date">${new Date(entry.date).toLocaleString()}</span>
                  <span class="status-name">${entry.status}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    })
    .catch(error => {
      console.error('Ошибка загрузки заказов:', error);
      ordersList.innerHTML = '<div class="empty-orders">Ошибка загрузки заказов</div>';
    });
}

// Инициализация
initUser();
loadProducts();
checkAdminAccess();
</script>
</body>
</html>